{% extends 'base.html' %}
{% block main %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/molstar-mutation/build/viewer/molstar.css" />
    <script type="text/javascript" src="/molstar-mutation/build/viewer/molstar.js"></script>
    {% if pdb is not defined %}
        {% if lineage is defined %}
            <h3>No data found for lineage {{lineage}}</h3>
            <p>Search for another: </p>
        {% elif lin_type1 is defined and lineage1 is defined %}
            <h3>Search for a lineage to compare against {{lin_type1}}: {{lineage1}}</h3>
        {% else %}
            <h3>Find a lineage to view</h3>
        {% endif %}
        <br>
        <form style="align-self: center;width: 75%" class="d-flex" id='search'>
            <input class="form-control me-2" placeholder="Search by lineage" aria-label="Search" id="search-box">
            <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
        <script>
            document.getElementById("search").onsubmit = function(e){
                {% if lin_type1 is defined and lineage1 is defined %}
                window.location.assign('{{url_for("search", lin_type1=lin_type1, lineage1=lineage1, _external=True)|safe}}&query='+document.getElementById('search-box').value);
                {% else %}
                window.location.assign('{{ url_for("search", _external=True) }}?query='+document.getElementById('search-box').value);     
                {% endif %}         
                e.preventDefault();
                return false;
            }
        </script>
    {% else %}
        {% block heading %}
        <h3 id="title">{{type|title}} Lineage: {{pdb}}</h3>
        <div class="d-flex">
            <div>
                <p>Relative mutation is a normalised measure of how many mutations occured at a given amino acid index</p>
                <a href="{{url_for('search', lin_type1=type, lineage1=pdb)}}">Add to comparison</a>
            </div>
            <div style="width: 10rem;"></div>
            <div>
                <div style="width: 25rem; background: rgb(252,251,253); background: linear-gradient(90deg, rgba(252,251,253,1) 0%, rgba(63,0,125,1) 100%); border: 2px; border-color: black; border-style: solid;">
                    <br>
                </div>
                <div class="flex-container">
                    <p style="float: left;">0.0</p>
                    <p style="float: right;">1.0</p>
                </div>
            </div>
        </div>
        {% endblock %}
        {% block viewer %}
        <div class="d-flex">
            <div style="width:100rem; float: left; height: 750px; overflow-y: scroll; overflow-x: hidden;">
                <table class="table" style="width: 20rem; position: relative;" id="mutation-table">
                    <thead>
                        <tr style="position: sticky; top:0; border: black; border-width: 1px; background-color: white;">
                            <th id="aa-index" title="Sort by amino acid index">Amino acid</th>
                            <th id="rel-mut" title="Sort by relative mutation">Relative mutation</th>
                        </tr>
                    </thead>
                    <tbody style="margin-top: 25px">
                        {% set i = namespace(value=0) %}
                        {% for index in mutation_counts.keys()|sort %}
                            <tr 
                                id="{{index}}" 
                                value="{{references[index]}}" 
                                onclick="{% if index not in missing %}mouseclickTable({{i.value}}, {{index}});{% else %}mouseclickTable(-1, {{index}});{% endif %}getMutants({{index}});this.style['background'] = 'rgba(200, 200, 200, 1)';this.onmouseleave=function(){};" 
                                onmouseover="{% if index not in missing %}mouseoverTable({{i.value}});{% endif %}this.style['background'] = 'rgba(200, 200, 200, 1)';" 
                                onmouseleave="{% if index not in missing %}mouseleaveTable({{i.value}});{% endif %}this.style['background'] = 'rgba(255, 255, 255, 1)'"
                                title="Click to view amino acid mutations"
                            >
                                <td>{{references[index]}}{{index}}{% if index in missing %}*{% endif %}</td>
                                <td>{{mutation_counts[index]}}</td>
                                {% if index not in missing %}{% set i.value = i.value + 1 %}{% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <script>
                    //  sortTable(f,n)
                    //  f : 1 ascending order, -1 descending order
                    //  n : n-th child(<td>) of <tr>
                    function sortTable(f,n){
                        var rows = $('#mutation-table tbody  tr').get();
        
                        rows.sort(function(a, b) {
        
                            var A = getVal(a);
                            var B = getVal(b);
        
                            if(A < B) {
                                return -1*f;
                            }
                            if(A > B) {
                                return 1*f;
                            }
                            return 0;
                        });
        
                        function getVal(elm){
                            var v = $(elm).children('td').eq(n).text().toUpperCase();
                            if($.isNumeric(v)){
                                if(v.includes('.')){
                                    v = parseFloat(v,10);
                                }
                                else{
                                    v = parseInt(v, 10);
                                }
                            }
                            else{
                                v = parseInt(v.substr(1), 10);
                            }
                            return v;
                        }
        
                        $.each(rows, function(index, row) {
                            $('#mutation-table').children('tbody').append(row);
                        });
                    }
                    var f_sl = 1; // flag to toggle the sorting order
                    var f_nm = 1; // flag to toggle the sorting order
                    $("#aa-index").click(function(){
                        f_sl *= -1; // toggle the sorting order
                        var n = $(this).prevAll().length;
                        sortTable(f_sl,n);
                    });
                    $("#rel-mut").click(function(){
                        f_nm *= -1; // toggle the sorting order
                        var n = $(this).prevAll().length;
                        sortTable(f_nm,n);
                    });
                </script>
            </div>
            <div>
                <div>
                    <div>
                        <style>
                            #app {
                                position:relative;
                                width: 60rem;
                                height: 750px;
                                float: right;
                                resize: both;
                                overflow: auto;
                            }
                        </style>
                        <div id="app" onmouseup="resize_check();" onmouseover="being_resized=false;" onmousemove="being_resized=false;"></div>
                        <script type="text/javascript">
                            var being_resized;
                            var viewer;

                            async function load_structure() {
                                viewer.plugin.is_reference = false;
                                await viewer.loadStructureFromUrl("/data/mutations/{{pdb}}.pdb", "pdb", false);
                                viewer.plugin.is_reference = true;
                                await viewer.loadStructureFromUrl("/data/reference-proteins/6vxx-blank.pdb", "pdb", false);
                            }

                            window.onload = async function(){
                                viewer = new molstar.Viewer('app', {
                                    layoutIsExpanded: false,
                                    layoutShowRemoteState: false,
                                    layoutShowSequence: true,
                                    layoutShowLog: false,
                                    layoutShowLeftPanel: false,
                                    viewportShowExpand: false,
                                    viewportShowSelectionMode: false,
                                    viewportShowAnimation: false,
                                    layoutShowControls: true,
                                    viewportShowExpand: false,
                                    collapseLeftPanel: true,
                                    pdbProvider: 'pdbe',
                                    emdbProvider: 'pdbe',
                                });
                                
                                await load_structure();

                                const resize_ob = new ResizeObserver(function(entries) {
                                    // Set the bool to show the app has been resized
                                    being_resized = true;
                                });
                                resize_ob.observe(document.querySelector('#app'));
                                being_resized = false;
                            }

                            async function resize_check(){
                                if (being_resized === true){
                                    //The element has just been resized so redraw it
                                    viewer.handleResize();
                                    being_resized = false;
                                }
                            }

                        </script>
                    </div>
                </div>
            </div>
        </div>
        <div>
            {% if missing|length > 0 %}
                <small>* This amino acid is missing in the reference model, so no mutations are shown</small>
            {% endif %}
        </div>
        <br>
        <div id="clear-button"></div>
        {% endblock %}
        <br>
        <br>
        <div>
            <div id="mutations"></div>
            <script>
                var mutations = {
                    {% for index in mutations.keys() %}
                        {{index}}: 
                            [
                                {% for aa in mutations[index].keys() %}
                                    [ 
                                        "{{aa}}", {{mutations[index][aa]}}
                                    ],
                                {% endfor %}
                            ],
                    {% endfor %}
                };
                function getMutants(index){
                    // Get the information on the mutations at this amino acid index
                    counts = mutations[index];
                    var reference = document.getElementById(index).attributes.value.nodeValue;
                    var html = "<h5>Reference amino acid: " + reference + "</h5>";
                    html = html + "<table class='table' style='width: 30%;'><tr><th>Amino acid mutation</th><th>Frequency</th></tr>";
                    var total = counts.map(x => x[1]).reduce((x, y) => x + y, 0);
                    for (var i=0; i<counts.length; i++){
                        aa = counts[i][0];
                        count = counts[i][1];    
                        html = html + "<tr><td>" + aa + "</td><td>" + Math.round(count/total *100000)/1000 + "%</tr>";
                    }
                    html = html + "</table>";
                    document.getElementById("mutations").innerHTML = html;
                    document.getElementById("mutations").scrollIntoView();
                }

                function mouseoverTable(index){
                    if(document.querySelectorAll("[title='[Structure] {{pdb}}.pdb']").length > 0){
                        var elem = document.querySelectorAll('[data-seqid="'+index+'"]')[0];
                        var event = new MouseEvent('mousemove', {
                                                    'bubbles': true,
                                                    'cancelable': true
                                                    });
                        elem.dispatchEvent(event);
                    }
                }
                function mouseleaveTable(index){
                    if(document.querySelectorAll("[title='[Structure] {{pdb}}.pdb']").length > 0){
                        var elem = document.querySelectorAll('[data-seqid="'+index+'"]')[0];
                        var event = new MouseEvent('mouseout', {
                                                    'bubbles': true,
                                                    'cancelable': true
                                                    });
                        elem.dispatchEvent(event);
                    }
                }
                function mouseclickTable(index, row_id){
                    //Check if another row already has focus, and clear as required
                    if(window.current_row !== undefined){
                        document.getElementById(window.current_row).onmouseleave = function(){
                            this.style['background'] = 'rgba(255, 255, 255, 1)';
                        }
                        document.getElementById(window.current_row).style['background'] = 'rgba(255, 255, 255, 1)';
                    }
                    //Focus on the given amino acid
                    if(document.querySelectorAll("[title='[Structure] {{pdb}}.pdb']").length > 0 && index >= 0){
                        var elem = document.querySelectorAll('[data-seqid="'+index+'"]')[0];
                        var event = new MouseEvent('mousedown', {
                                                    'bubbles': true,
                                                    'cancelable': true
                                                    });
                        elem.dispatchEvent(event);
                    }
                    document.getElementById("clear-button").innerHTML = "<button class='btn btn-outline-success' onclick='clearFocus("+row_id+");'>Clear selection</button>";
                    window.current_row = row_id
                }
                function clearFocus(id){
                    //Clear the focus on an amino acid by clicking the sequence number
                    var elem = document.querySelectorAll('[class="msp-sequence-number"]')[0];
                    var event = new MouseEvent('mousedown', {'bubbles': true, 'cancelable': true});
                    elem.dispatchEvent(event);
                    //Remove this button and the table
                    document.getElementById("clear-button").innerHTML = "";
                    document.getElementById("mutations").innerHTML = "";
                    //Revert the row to the usual formatting
                    document.getElementById(id).onmouseleave = function(){
                        this.style['background'] = 'rgba(255, 255, 255, 1)';
                    }
                    document.getElementById(id).style['background'] = 'rgba(255, 255, 255, 1)';
                    //Scroll back up
                    document.getElementById("title").scrollIntoView();
                }
            </script>
        </div>
    {% endif %}
{% endblock %}