{% extends 'base.html' %}
{% block main %}
    <style>
        #app {
            margin-left: 0%;
            margin-right: 0%;
            border: 0ch;
            position:fixed;
            width: 50%;
            height: 75%;
            align-self: center;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="/molstar-mutation/build/viewer/molstar.css" />
    <div style="text-align: center;align-content: center;">
        <h3>Pango Lineage: {{pdb}}</h3>
        <br>
        <div>
            <div id="app"></div>
            <script type="text/javascript" src="/molstar-mutation/build/viewer/molstar.js"></script>
            <script type="text/javascript">
                function sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                    }

                async function load_structure() {
                    viewer.plugin.is_reference = true;
                    await viewer.loadStructureFromUrl("/data/reference-proteins/6vxx-blank.pdb", "pdb", false);
                    // await sleep(2000);
                    viewer.plugin.is_reference = false;
                    await viewer.loadStructureFromUrl("/data/mutations/{{pdb}}.pdb", "pdb", false);
                }
                function getParam(name, regex) {
                    var r = new RegExp(name + '=' + '(' + regex + ')[&]?', 'i');
                    return decodeURIComponent(((window.location.search || '').match(r) || [])[1] || '');
                }

                var debugMode = getParam('debug-mode', '[^&]+').trim() === '1';
                if (debugMode) molstar.setDebugMode(debugMode, debugMode);

                var hideControls = getParam('hide-controls', '[^&]+').trim() === '1';
                var collapseLeftPanel = getParam('collapse-left-panel', '[^&]+').trim() === '1';
                var pdbProvider = getParam('pdb-provider', '[^&]+').trim().toLowerCase();
                var emdbProvider = getParam('emdb-provider', '[^&]+').trim().toLowerCase();
                var viewer = new molstar.Viewer('app', {
                    layoutIsExpanded: false,
                    layoutShowRemoteState: false,
                    layoutShowSequence: true,
                    layoutShowLog: false,
                    layoutShowLeftPanel: false,
                    viewportShowExpand: false,
                    viewportShowSelectionMode: false,
                    viewportShowAnimation: false,
                    layoutShowControls: true,
                    viewportShowExpand: false,
                    collapseLeftPanel: collapseLeftPanel,
                    pdbProvider: pdbProvider || 'pdbe',
                    emdbProvider: emdbProvider || 'pdbe',
                });
                
                load_structure();
            </script>
        </div>
    </div>
{% endblock %}